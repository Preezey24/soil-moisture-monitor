AWSTemplateFormatVersion: '2010-09-09'
Description: 'IoT Rules + CloudWatch Dashboard for Soil Moisture Monitoring (IoT-only integration)'

Parameters:
  DashboardName:
    Type: String
    Default: 'SoilMoistureDashboard'
    Description: 'Name for the CloudWatch dashboard'
  
  IoTTopicName:
    Type: String
    Default: 'soil-moisture/data'
    Description: 'IoT topic where sensor data is published'
  
  AWSRegion:
    Type: String
    Default: 'us-east-1'
    Description: 'AWS Region where metrics are published'
    AllowedValues:
      - us-east-1
      - us-west-2
      - eu-west-1
      - eu-central-1
      - ap-southeast-1
      - ap-southeast-2

Resources:
  # IAM Role for IoT Rule to write to CloudWatch
  IoTCloudWatchRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: 'SoilMoisture_IoTCloudWatchRole'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: iot.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudWatchMetricsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'

  # IoT Rules to route batch sensor readings to CloudWatch (one rule per sensor)
  SoilMoistureSensor1Rule:
    Type: AWS::IoT::TopicRule
    Properties:
      RuleName: 'SoilMoisture_Sensor1_Rule'
      TopicRulePayload:
        Description: 'Route sensor 1 data to CloudWatch metrics'
        Sql: !Sub |
          SELECT 
            get(batch_sensor_data, 0).moisture_value as metricValue,
            get(batch_sensor_data, 0).sensor_name as sensorName,
            get(batch_sensor_data, 0).pin as pin,
            get(batch_sensor_data, 0).location as location,
            timestamp() as metricTimestamp
          FROM '${IoTTopicName}'
          WHERE get(batch_sensor_data, 0).moisture_value IS NOT NULL
        Actions:
          - CloudwatchMetric:
              RoleArn: !GetAtt IoTCloudWatchRole.Arn
              MetricNamespace: 'IoT/SoilMoisture'
              MetricName: 'SoilMoisture'
              MetricValue: '${metricValue}'
              MetricUnit: 'None'
              MetricTimestamp: '${metricTimestamp}'
              MetricDimensions:
                SensorName: '${sensorName}'
        RuleDisabled: false

  SoilMoistureSensor2Rule:
    Type: AWS::IoT::TopicRule
    Properties:
      RuleName: 'SoilMoisture_Sensor2_Rule'
      TopicRulePayload:
        Description: 'Route sensor 2 data to CloudWatch metrics'
        Sql: !Sub |
          SELECT 
            get(batch_sensor_data, 1).moisture_value as metricValue,
            get(batch_sensor_data, 1).sensor_name as sensorName,
            get(batch_sensor_data, 1).pin as pin,
            get(batch_sensor_data, 1).location as location,
            timestamp() as metricTimestamp
          FROM '${IoTTopicName}'
          WHERE get(batch_sensor_data, 1).moisture_value IS NOT NULL
        Actions:
          - CloudwatchMetric:
              RoleArn: !GetAtt IoTCloudWatchRole.Arn
              MetricNamespace: 'IoT/SoilMoisture'
              MetricName: 'SoilMoisture'
              MetricValue: '${metricValue}'
              MetricUnit: 'None'
              MetricTimestamp: '${metricTimestamp}'
              MetricDimensions:
                SensorName: '${sensorName}'
        RuleDisabled: false

  SoilMoistureSensor3Rule:
    Type: AWS::IoT::TopicRule
    Properties:
      RuleName: 'SoilMoisture_Sensor3_Rule'
      TopicRulePayload:
        Description: 'Route sensor 3 data to CloudWatch metrics'
        Sql: !Sub |
          SELECT 
            get(batch_sensor_data, 2).moisture_value as metricValue,
            get(batch_sensor_data, 2).sensor_name as sensorName,
            get(batch_sensor_data, 2).pin as pin,
            get(batch_sensor_data, 2).location as location,
            timestamp() as metricTimestamp
          FROM '${IoTTopicName}'
          WHERE get(batch_sensor_data, 2).moisture_value IS NOT NULL
        Actions:
          - CloudwatchMetric:
              RoleArn: !GetAtt IoTCloudWatchRole.Arn
              MetricNamespace: 'IoT/SoilMoisture'
              MetricName: 'SoilMoisture'
              MetricValue: '${metricValue}'
              MetricUnit: 'None'
              MetricTimestamp: '${metricTimestamp}'
              MetricDimensions:
                SensorName: '${sensorName}'
        RuleDisabled: false
  # CloudWatch Dashboard
  SoilMoistureDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Ref DashboardName
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["IoT/SoilMoisture", "SoilMoisture", "SensorName", "sensor_1"],
                  [".", ".", ".", "sensor_2"],
                  [".", ".", ".", "sensor_3"]
                ],
                "period": 60,
                "stat": "Average",
                "region": "${AWSRegion}",
                "title": "Soil Moisture Levels - All Sensors (IoT Rules Routing)",
                "yAxis": {
                  "left": {
                    "min": 0,
                    "max": 1023
                  }
                },
                "view": "timeSeries",
                "stacked": false
              }
            }
          ]
        }

Outputs:
  IoTSensor1RuleArn:
    Description: 'ARN of the IoT Rule routing sensor 1 data to CloudWatch'
    Value: !GetAtt SoilMoistureSensor1Rule.Arn
    
  IoTSensor2RuleArn:
    Description: 'ARN of the IoT Rule routing sensor 2 data to CloudWatch'
    Value: !GetAtt SoilMoistureSensor2Rule.Arn
    
  IoTSensor3RuleArn:
    Description: 'ARN of the IoT Rule routing sensor 3 data to CloudWatch'
    Value: !GetAtt SoilMoistureSensor3Rule.Arn
    
  CloudWatchRoleArn:
    Description: 'ARN of the IAM role used by IoT to write to CloudWatch'
    Value: !GetAtt IoTCloudWatchRole.Arn
    
  DashboardURL:
    Description: 'URL to access the CloudWatch dashboard'
    Value: !Sub 'https://${AWSRegion}.console.aws.amazon.com/cloudwatch/home?region=${AWSRegion}#dashboards:name=${DashboardName}'
    Export:
      Name: !Sub '${AWS::StackName}-DashboardURL'
  
  DashboardName:
    Description: 'Name of the created dashboard'
    Value: !Ref DashboardName
    Export:
      Name: !Sub '${AWS::StackName}-DashboardName'
